{# templates/article/article_detail.html #}
{% extends "article_base.html" %}

{% block title %}{{ display_title|default:article.title }}{% endblock %}

{% block content %}
<article class="max-w-4xl mx-auto">
  <div class="rounded-xl border border-gray-200 bg-white p-6">
    <header class="mb-4">
      <h1 lang="{{ lang }}" class="text-2xl font-semibold leading-snug">
        {% if article.url %}
          <a href="{{ article.url }}" target="_blank" class="text-sky-700 hover:underline">{{ display_title|default:article.title }}</a>
        {% else %}
          {{ display_title|default:article.title }}
        {% endif %}
      </h1>
      <div lang="{{ lang }}" class="mt-2 text-sm text-gray-600 flex flex-wrap items-center gap-3">
        <span>公開日: {{ article.publish|date:"Y-m-d" }}</span>
        <span>タグ:
          {% for tag in article.tags.all %}
            <span class="inline-block rounded bg-gray-100 px-2 py-0.5 text-xs text-gray-700 border">{{ tag.name }}</span>
          {% empty %}
            <em class="text-gray-400">なし</em>
          {% endfor %}
        </span>
      </div>
    </header>

    <hr class="my-4" />

    <div lang="{{ lang }}" class="prose prose-sm text-base max-w-none space-y-4">
      {{ display_body|default:article.text|safe }}
    </div>

    <div class="mt-6">
      <a href="{% url 'article:article_list' %}" class="text-sky-700 hover:underline">← 一覧に戻る</a>
    </div>
  </div>
</article>

<script>
document.addEventListener("DOMContentLoaded", function () {
  document.addEventListener("contextmenu", function (e) {
    const selection = window.getSelection().toString().trim();

    // ✅ Only intercept when user holds Shift (native "Copy" remains intact)
    if (selection.length > 0 && e.shiftKey) {
      e.preventDefault();

      if (confirm(`Save this to vocabulary?\n\n"${selection}"`)) {
        fetch("/article/save-vocabulary/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"),
          },
          body: JSON.stringify({
            article_id: "{{ article.id }}",
            word: selection
            // meaning omitted → server will store NULL
          }),
        })
        .then(r => r.json())
        .then(() => alert("Saved!"))
        .catch(err => {
          console.error("Save failed:", err);
          alert("Save failed.");
        });
      }
    }
    // else: do nothing → native context menu shows (copy works)
  });

  // Cookie helper (decodes URL-encoded values)
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
});
</script>

{% endblock %}